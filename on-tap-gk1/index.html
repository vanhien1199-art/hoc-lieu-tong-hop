<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc nghiệm Vật Lí - Năng lượng & Cơ học</title>
    <style>
        /* CSS Reset and Basic Styling */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #e9ecef;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Main Container Styling */
        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            position: relative;
        }

        /* Screen Sections Styling */
        .screen {
            padding: 40px;
            transition: opacity 0.4s ease-in-out;
        }
        
        .screen.hide {
            display: none;
        }

        /* Header and Title Styling */
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        h1 {
            font-size: 2.5rem;
        }

        h2 {
           font-size: 2rem;
        }


        /* Start Screen Specifics */
        #start-screen {
            text-align: center;
        }

        .input-group {
            margin: 20px 0;
        }

        #player-name {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            font-size: 1rem;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: center;
        }

        /* Quiz Screen Specifics */
        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        #question-counter {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        #score-display {
             background-color: var(--success-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
        }

        #question-container {
            margin-bottom: 20px;
            min-height: 100px;
            font-size: 1.3rem;
            text-align: center;
            transition: opacity 0.3s ease-in-out;
        }

        #answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Buttons Styling */
        .btn {
            background-color: var(--light-color);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
        }
        
        .btn:before {
            content: attr(data-option);
            font-weight: bold;
            margin-right: 10px;
            background-color: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }


        .btn:hover:not(:disabled) {
            background-color: #dbe9ff;
            transform: translateY(-2px);
        }

        .btn.correct {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        .btn.correct:before{
            background-color: white;
            color: var(--success-color);
        }

        .btn.wrong {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }
        .btn.wrong:before{
            background-color: white;
            color: var(--danger-color);
        }
        
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .control-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 20px auto 0;
            padding: 15px;
            font-size: 1.2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .control-btn:hover {
            background-color: #0056b3;
        }

        #export-btn {
            margin: 0 auto 15px;
            background-color: var(--success-color);
            border-color: #1e7e34;
        }

        #export-btn:hover {
            background-color: #218838;
        }

        /* End Screen & Leaderboard */
        #end-screen {
            text-align: center;
        }
        #final-score-text {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        #leaderboard {
            margin-top: 30px;
            width: 100%;
            border-collapse: collapse;
        }

        #leaderboard th, #leaderboard td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        #leaderboard th {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
        }
        #leaderboard tr:nth-child(even) {
            background-color: var(--light-color);
        }
        #leaderboard tr:hover {
            background-color: #ddd;
        }

        /* Footer and Home Button Styling */
        footer {
            margin-top: 20px;
            text-align: center;
            color: var(--secondary-color);
        }
        
        #home-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        #home-btn.hide {
            display: none;
        }

        /* Responsive design */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .screen {
                padding: 20px;
            }
            h1 {
                font-size: 2rem;
            }
            #answer-buttons {
                grid-template-columns: 1fr;
            }
            #home-btn {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <button id="home-btn" class="hide" title="Trang chủ">&#8962;</button>

        <!-- Màn hình Bắt đầu -->
        <section id="start-screen" class="screen">
            <h1>TRÒ CHƠI TRẮC NGHIỆM VẬT LÍ</h1>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Nhập tên của bạn">
            </div>
            <button id="start-btn" class="control-btn">Bắt đầu làm bài</button>
        </section>

        <!-- Màn hình Trò chơi -->
        <section id="quiz-screen" class="screen hide">
            <div id="quiz-header">
                <div id="question-counter">Câu 1/31</div>
                <div id="score-display">Điểm: 0</div>
            </div>
            <div id="question-container">
                <p id="question-text">Đây là nội dung câu hỏi?</p>
            </div>
            <div id="answer-buttons">
                <!-- Buttons will be generated by JS -->
            </div>
        </section>

        <!-- Màn hình Kết quả -->
        <section id="end-screen" class="screen hide">
            <h2 id="result-title">Chúc mừng!</h2>
            <p id="final-score-text">Bạn đã đạt 0/31</p>
            <button id="play-again-btn" class="control-btn">Chơi lại</button>

            <div id="leaderboard-container">
                <h2>Bảng xếp hạng</h2>
                <button id="export-btn" class="control-btn">Xuất file CSV</button>
                <table id="leaderboard">
                    <thead>
                        <tr>
                            <th>Tên</th>
                            <th>Điểm</th>
                            <th>Ngày chơi</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Scores will be generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <footer>
        <p>&copy; 2025 - NUNG VAN HIEN</p>
    </footer>

    <script>
    // This event listener ensures that the script runs only after the entire HTML document has been loaded and parsed.
    document.addEventListener('DOMContentLoaded', () => {

        // --- DATA SOURCE ---
        const questions = [
            {
                question: "Động năng của một vật phụ thuộc vào yếu tố nào?",
                answers: [
                    { text: "Khối lượng và tốc độ của vật.", correct: true },
                    { text: "Khối lượng và độ cao của vật.", correct: false },
                    { text: "Tốc độ và hình dạng của vật.", correct: false },
                    { text: "Độ cao và hình dạng của vật.", correct: false }
                ]
            },
            {
                question: "Trong các vật sau, vật nào không có động năng?",
                answers: [
                    { text: "Hòn bi nằm yên trên mặt sàn.", correct: true },
                    { text: "Hòn bi lăn trên sàn nhà.", correct: false },
                    { text: "Máy bay đang bay.", correct: false },
                    { text: "Viên đạn đang bay.", correct: false }
                ]
            },
            {
                question: "Đơn vị đo của thế năng trọng trường là gì?",
                answers: [
                    { text: "Niuton (N).", correct: false },
                    { text: "Jun (J).", correct: true },
                    { text: "Kilôgam (kg).", correct: false },
                    { text: "Mét trên giây bình phương (m/s²).", correct: false }
                ]
            },
            {
                question: "Vật có khối lượng càng lớn, vận tốc càng lớn thì",
                answers: [
                    { text: "thế năng vật càng lớn.", correct: false },
                    { text: "động năng vật càng lớn.", correct: true },
                    { text: "thế năng vật càng nhỏ.", correct: false },
                    { text: "động năng vật càng nhỏ.", correct: false }
                ]
            },
            {
                question: "Trong các vật sau, vật nào không có thế năng (so với mặt đất)?",
                answers: [
                    { text: "Chiếc máy bay đang bay trên cao", correct: false },
                    { text: "Em bé đang ngồi trên xích đu", correct: false },
                    { text: "Ô tô đang đậu trong bến xe", correct: true },
                    { text: "Con chim bay lượn trên bầu trời", correct: false }
                ]
            },
            {
                question: "Nếu chọn mặt đất làm mốc để tính thế năng thì trong các vật sau đây vật nào không có thế năng?",
                answers: [
                    { text: "Viên đạn đang bay.", correct: false },
                    { text: "Lò xo để tự nhiên ở một độ cao so với mặt đất.", correct: false },
                    { text: "Hòn bi đang lăn trên mặt đất.", correct: true },
                    { text: "Lò xo bị ép đặt ngay trên mặt đất.", correct: false }
                ]
            },
            {
                question: "Động năng của một ô tô thay đổi như thế nào khi tốc độ của nó tăng lên gấp đôi?",
                answers: [
                    { text: "Động năng tăng gấp đôi.", correct: false },
                    { text: "Động năng tăng gấp bốn lần.", correct: true },
                    { text: "Động năng giảm hai lần.", correct: false },
                    { text: "Động năng không đổi.", correct: false }
                ]
            },
            {
                question: "Trong những vật sau, cho biết vật nào có động năng lớn nhất?",
                answers: [
                    { text: "Quả bóng đang bay tới rổ", correct: false },
                    { text: "Ô tô đang di chuyển trên đường cao tốc", correct: false },
                    { text: "Viên bi đang lăn trên sàn", correct: false },
                    { text: "Máy bay đang chuyển động trên bầu trời", correct: true }
                ]
            },
            {
                question: "Nếu tốc độ của một vật tăng lên gấp ba lần thì động năng của vật sẽ thay đổi như thế nào?",
                answers: [
                    { text: "Tăng gấp ba lần.", correct: false },
                    { text: "Tăng gấp chín lần.", correct: true },
                    { text: "Không thay đổi.", correct: false },
                    { text: "Giảm đi một nửa", correct: false }
                ]
            },
             {
                question: "Tìm câu sai. Động năng của một vật không đổi khi",
                answers: [
                    { text: "chuyển động thẳng đều.", correct: false },
                    { text: "chuyển động tròn đều.", correct: false },
                    { text: "chuyển động cong đều.", correct: false },
                    { text: "chuyển động biến đổi đều.", correct: true }
                ]
            },
            {
                question: "Hai vật đặc cùng làm bằng nhôm, vật A có khối lượng lớn hơn vật B. Cả hai vật cùng rơi xuống từ một độ cao như nhau. Thế năng trọng trường của vật nào lớn hơn?",
                answers: [
                    { text: "Vật A.", correct: true },
                    { text: "Vật B.", correct: false },
                    { text: "Thế năng trọng trường của hai vật bằng nhau.", correct: false },
                    { text: "Không so sánh được.", correct: false }
                ]
            },
             {
                question: "Hai vật có khối lượng là m và 2m đặt ở hai độ cao lần lượt là 2h và h. Thế năng trọng trường của vật thứ nhất so với vật thứ hai là",
                answers: [
                    { text: "bằng hai lần vật thứ hai.", correct: true },
                    { text: "bằng một nửa vật thứ hai.", correct: false },
                    { text: "bằng vật thứ hai.", correct: false },
                    { text: "bằng 1/4 vật thứ hai.", correct: false }
                ]
            },
             {
                question: "Một vật có khối lượng 3 kg ở độ cao 4 m so với mặt đất. Hỏi thế năng trọng trường của vật là bao nhiêu? (Lấy g ≈ 10 m/s²)",
                answers: [
                    { text: "120 J.", correct: true },
                    { text: "30 J.", correct: false },
                    { text: "60 J.", correct: false },
                    { text: "12 J.", correct: false }
                ]
            },
             {
                question: "Khi một vận động viên cử tạ nâng tạ từ sàn lên và qua đầu thì",
                answers: [
                    { text: "thế năng hấp dẫn của tạ tăng dần.", correct: true },
                    { text: "thế năng hấp dẫn của tạ giảm dần.", correct: false },
                    { text: "thế năng hấp dẫn của tạ không thay đổi.", correct: false },
                    { text: "thế năng hấp dẫn của tạ có lúc tăng, có lúc giảm.", correct: false }
                ]
            },
            {
                question: "Trong quá trình dao động của một con lắc đơn thì tại vị trí cân bằng",
                answers: [
                    { text: "động năng đạt giá trị cực đại.", correct: true },
                    { text: "thế năng đạt giá trị cực đại.", correct: false },
                    { text: "cơ năng bằng không.", correct: false },
                    { text: "thế năng bằng động năng.", correct: false }
                ]
            },
            {
                question: "Một vật nhỏ được ném lên từ điểm M phía trên mặt đất; vật lên tới điểm N thì dừng và rơi xuống. Bỏ qua sức cản của không khí. Trong quá trình MN?",
                answers: [
                    { text: "thế năng giảm.", correct: false },
                    { text: "cơ năng cực đại tại N.", correct: false },
                    { text: "cơ năng không đổi.", correct: true },
                    { text: "động năng tăng.", correct: false }
                ]
            },
            {
                question: "Một vật được ném lên cao theo phương thẳng đứng. Khi nào có sự chuyển hóa từ thế năng thành động năng?",
                answers: [
                    { text: "Chỉ khi vật đang đi lên.", correct: false },
                    { text: "Chỉ khi vật đang rơi xuống.", correct: true },
                    { text: "Chỉ khi vật lên tới điểm cao nhất.", correct: false },
                    { text: "Cả khi vật đang đi lên và rơi xuống.", correct: false }
                ]
            },
            {
                question: "Trong quá trình rơi tự do của một vật thì",
                answers: [
                    { text: "Động năng tăng, thế năng tăng", correct: false },
                    { text: "Động năng tăng, thế năng giảm", correct: true },
                    { text: "Động năng giảm, thế năng giảm", correct: false },
                    { text: "Động năng giảm, thế năng tăng", correct: false }
                ]
            },
            {
                question: "Phát biểu nào sau đây đúng khi nói về sự chuyển hóa cơ năng?",
                answers: [
                    { text: "Chỉ có động năng mới chuyển hóa thành thế năng.", correct: false },
                    { text: "Chỉ có thế năng mới chuyển hóa thành động năng.", correct: false },
                    { text: "Động năng và thế năng có thể chuyển hóa qua lại lẫn nhau nhưng cơ năng được bảo toàn.", correct: true },
                    { text: "Chỉ có cơ năng mới chuyển hóa thành động năng và thế năng.", correct: false }
                ]
            },
            {
                question: "Khi cưa thép, đã có sự chuyển hóa và truyền năng lượng nào xảy ra?",
                answers: [
                    { text: "Cơ năng chuyển hóa thành nhiệt năng.", correct: true },
                    { text: "Cơ năng chuyển hóa thành động năng.", correct: false },
                    { text: "Cơ năng chuyển hóa thành công cơ học.", correct: false },
                    { text: "Cơ năng chuyển hóa thành thế năng.", correct: false }
                ]
            },
             {
                question: "Trong các câu nhận xét sau câu nào sai?",
                answers: [
                    { text: "Trong quá trình cơ học, động năng và thế năng có thể chuyển hóa lẫn nhau, nhưng cơ năng được bảo toàn.", correct: false },
                    { text: "Quả bóng có vận tốc lớn nhất khi nó lên đến điểm cao nhất.", correct: true },
                    { text: "Nước chảy từ trên cao xuống thì thế năng chuyển thành động năng.", correct: false },
                    { text: "Nếu kể đến ma sát thì cơ năng của vật không được bảo toàn.", correct: false }
                ]
            },
            {
                question: "Trong các trường hợp sau trường hợp nào động năng chuyển hóa thành thế năng? (Lấy mặt đất làm mốc tính thế năng).",
                answers: [
                    { text: "Vật lăn từ máng nghiêng xuống.", correct: false },
                    { text: "Xe đạp đi trên đường bằng.", correct: false },
                    { text: "Quả bóng nảy lên.", correct: true },
                    { text: "Hạt mưa rơi.", correct: false }
                ]
            },
            {
                question: "Biểu thức tính công suất là:",
                answers: [
                    { text: "P = A.t", correct: false },
                    { text: "P = A / t", correct: true },
                    { text: "P = t / A", correct: false },
                    { text: "P = A.t²", correct: false }
                ]
            },
            {
                question: "Điều nào sau đây đúng khi nói về công suất?",
                answers: [
                    { text: "Công suất được xác định bằng công thực hiện được trong một đơn vị thời gian.", correct: true },
                    { text: "Công suất được xác định bằng lực tác dụng trong 1 giây.", correct: false },
                    { text: "Công suất được xác định bằng công thức P = A.t", correct: false },
                    { text: "Công suất được xác định bằng công thực hiện khi vật dịch chuyển được 1 mét.", correct: false }
                ]
            },
            {
                question: "Vật nào sau đây có khả năng sinh công",
                answers: [
                    { text: "Viên phấn đặt trên mặt bàn", correct: false },
                    { text: "Chiếc bút đang rơi", correct: true },
                    { text: "Nước trong cốc đặt trên bàn", correct: false },
                    { text: "Hòn đá đang nằm trên mặt đất", correct: false }
                ]
            },
            {
                question: "Đơn vị không phải đơn vị của công suất là",
                answers: [
                    { text: "N.m/s.", correct: false },
                    { text: "W.", correct: false },
                    { text: "J.s.", correct: true },
                    { text: "HP.", correct: false }
                ]
            },
             {
                question: "Trường hợp nào sau đây có công cơ học? Chọn đáp án đúng nhất.",
                answers: [
                    { text: "Khi có lực tác dụng vào vật.", correct: false },
                    { text: "Khi có lực tác dụng vào vật và vật chuyển động theo phương vuông góc với phương của lực.", correct: false },
                    { text: "Khi có lực tác dụng vào vật và vật chuyển động theo phương không vuông góc với phương của lực.", correct: true },
                    { text: "Khi có lực tác dụng vào vật nhưng vật vẫn đứng yên.", correct: false }
                ]
            },
             {
                question: "Trường hợp nào sau đây không sinh công?",
                answers: [
                    { text: "Cầu thủ bóng đá sút vào trái bóng", correct: false },
                    { text: "Vận động viên cầu lông đang đánh cầu", correct: false },
                    { text: "Vận động viên cờ vua đang ngồi yên suy nghĩ", correct: true },
                    { text: "Vận động viên đẩy tạ đang đẩy quả tạ bay đi", correct: false }
                ]
            },
            {
                question: "Phát biểu nào dưới đây là đúng?",
                answers: [
                    { text: "Máy có công suất lớn thì hiệu suất của máy đó nhất định cao", correct: false },
                    { text: "Hiệu suất của một máy có thể lớn hơn 1", correct: false },
                    { text: "Máy có hiệu suất cao thì công suất của máy nhất định lớn", correct: false },
                    { text: "Máy có công suất lớn thì thời gian sinh công sẽ nhanh", correct: true }
                ]
            },
            {
                question: "Để cày một sào đất, nếu dùng trâu cày thì mất 2 giờ, nếu dùng máy cày thì mất 20 phút. Hỏi trâu hay máy cày có công suất lớn hơn và lớn hơn bao nhiêu lần?",
                answers: [
                    { text: "Máy cày có công suất lớn hơn và lớn hơn 3 lần.", correct: false },
                    { text: "Máy cày có công suất lớn hơn và lớn hơn 6 lần.", correct: true },
                    { text: "Máy cày có công suất lớn hơn và lớn hơn 5 lần.", correct: false },
                    { text: "Máy cày có công suất lớn hơn và lớn hơn 10 lần.", correct: false }
                ]
            }
        ];


        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const endScreen = document.getElementById('end-screen');
        
        const playerNameInput = document.getElementById('player-name');
        const startButton = document.getElementById('start-btn');
        const playAgainButton = document.getElementById('play-again-btn');
        const homeButton = document.getElementById('home-btn');
        const exportButton = document.getElementById('export-btn');

        // Added missing element declarations
        const questionCounter = document.getElementById('question-counter');
        const scoreDisplay = document.getElementById('score-display');
        const questionText = document.getElementById('question-text');
        const answerButtons = document.getElementById('answer-buttons');
        const resultTitle = document.getElementById('result-title');
        const finalScoreText = document.getElementById('final-score-text');
        const leaderboardBody = document.getElementById('leaderboard-body');


        // --- GAME STATE ---
        let shuffledQuestions, currentQuestionIndex;
        let score = 0;
        let playerName = '';
        const SCORE_STORAGE_KEY = 'physicsQuizHighScores';

        // --- EVENT LISTENERS ---
        startButton.addEventListener('click', startGame);
        playAgainButton.addEventListener('click', startGame);
        exportButton.addEventListener('click', exportToCsv);
        homeButton.addEventListener('click', () => {
             // A simple way to reset the app is to reload the page
            location.reload();
        });

        // --- FUNCTIONS ---
        
        function startGame() {
            playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert('Vui lòng nhập tên của bạn để bắt đầu!');
                return;
            }
            
            score = 0;
            scoreDisplay.innerText = `Điểm: ${score}`;
            shuffledQuestions = questions.sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;

            startScreen.classList.add('hide');
            endScreen.classList.add('hide');
            quizScreen.classList.remove('hide');
            homeButton.classList.remove('hide');

            setNextQuestion();
        }

        function setNextQuestion() {
            resetState();
            if (currentQuestionIndex < shuffledQuestions.length) {
                showQuestion(shuffledQuestions[currentQuestionIndex]);
            } else {
                endGame();
            }
        }
        
        function showQuestion(question) {
            questionText.innerText = question.question;
            questionCounter.innerText = `Câu ${currentQuestionIndex + 1}/${shuffledQuestions.length}`;
            
            const options = ['A', 'B', 'C', 'D'];
            question.answers.forEach((answer, index) => {
                const button = document.createElement('button');
                button.innerHTML = answer.text; // Use innerHTML to render entities if any
                button.classList.add('btn');
                button.dataset.option = options[index];

                if (answer.correct) {
                    button.dataset.correct = true;
                }
                
                button.addEventListener('click', selectAnswer);
                answerButtons.appendChild(button);
            });
        }
        
        function resetState() {
            while (answerButtons.firstChild) {
                answerButtons.removeChild(answerButtons.firstChild);
            }
            questionText.style.opacity = 1;
        }

        function selectAnswer(e) {
            // Use currentTarget to ensure we always get the button, even if user clicks on text inside it.
            const selectedButton = e.currentTarget; 
            const isCorrect = selectedButton.dataset.correct === 'true';

            Array.from(answerButtons.children).forEach(button => {
                 button.disabled = true;
            });

            if (isCorrect) {
                score++;
                scoreDisplay.innerText = `Điểm: ${score}`;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('wrong');
                const correctButton = Array.from(answerButtons.children).find(button => button.dataset.correct === 'true');
                if(correctButton) {
                    correctButton.classList.add('correct');
                }
            }

            questionText.style.opacity = 0;
            setTimeout(() => {
                currentQuestionIndex++;
                setNextQuestion();
            }, 1500); 
        }

        function endGame() {
            saveScore();
            quizScreen.classList.add('hide');
            endScreen.classList.remove('hide');
            
            resultTitle.innerText = `Chúc mừng ${playerName}!`;
            finalScoreText.innerText = `Bạn đã đạt ${score} / ${shuffledQuestions.length} điểm`;
            
            displayLeaderboard();
        }

        function saveScore() {
            const newScore = {
                name: playerName,
                score: score,
                date: new Date().toLocaleString('vi-VN')
            };

            const highScores = JSON.parse(localStorage.getItem(SCORE_STORAGE_KEY)) || [];
            highScores.push(newScore);
            localStorage.setItem(SCORE_STORAGE_KEY, JSON.stringify(highScores));
        }

        function displayLeaderboard() {
            const highScores = JSON.parse(localStorage.getItem(SCORE_STORAGE_KEY)) || [];

            highScores.sort((a, b) => b.score - a.score);

            leaderboardBody.innerHTML = '';
            
            if (highScores.length === 0) {
                 leaderboardBody.innerHTML = `<tr><td colspan="3">Chưa có ai chơi. Hãy là người đầu tiên!</td></tr>`;
            } else {
                highScores.forEach(scoreEntry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${scoreEntry.name}</td>
                        <td>${scoreEntry.score}</td>
                        <td>${scoreEntry.date}</td>
                    `;
                    leaderboardBody.appendChild(row);
                });
            }
        }

        /**
         * Exports leaderboard data to a downloadable CSV file.
         */
        function exportToCsv() {
            const highScores = JSON.parse(localStorage.getItem(SCORE_STORAGE_KEY)) || [];

            if (highScores.length === 0) {
                alert("Chưa có dữ liệu điểm để xuất file!");
                return;
            }
            
            // Sort data before exporting, same as leaderboard display
            highScores.sort((a, b) => b.score - a.score);

            // CSV Headers - Add BOM for proper UTF-8 encoding in Excel
            const bom = "\uFEFF";
            const csvHeaders = ['"Tên"', '"Điểm"', '"Ngày chơi"'];
            const csvRows = [csvHeaders.join(',')];

            // Convert each score object to a CSV row
            for (const score of highScores) {
                // Sanitize name in case it contains a comma or quotes
                const name = `"${score.name.replace(/"/g, '""')}"`;
                const points = score.score;
                const date = `"${score.date}"`;
                csvRows.push([name, points, date].join(','));
            }

            const csvString = bom + csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            
            // Create a link and trigger the download
            const link = document.createElement("a");
            if (link.download !== undefined) { // Check for browser support
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "bang_diem_vat_li.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }
    });
    </script>
</body>
</html>

